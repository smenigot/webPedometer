function Kalman(){this.G=1;this.Rw=1;this.Rv=10;this.A=1;this.C=1;this.B=0;this.u=0;this.P=NaN;this.x=NaN;this.y=NaN;this.onFilteringKalman=function(e){this.y=e;if(isNaN(this.x)){this.x=1/this.C*this.y;this.P=1/this.C*this.Rv*1/this.C}else{this.x=this.A*this.x+this.B*this.u;this.P=this.A*this.P*this.A+this.Rw;this.G=this.P*this.C*1/(this.C*this.P*this.C+this.Rv);this.x=this.x+this.G*(this.y-this.C*this.x);this.P=this.P-this.G*this.C*this.P}return this.x};this.setRv=function(e){this.Rv=e}}function Pedometer(){this.acc_norm=new Array;this.var_acc=0;this.min_acc=1/0;this.max_acc=-1/0;this.threshold=-1/0;this.sensibility=1/30;this.countStep=0;this.stepArr=new Array;this.weight=70;this.stepSize=50;this.distance=0;this.calory=0;this.speed=0;this.meanSpeed=0;this.filtre=new Kalman;this.setCountStep=function(e){this.countStep=e};this.setWeight=function(e){this.weight=e};this.setStepSize=function(e){this.stepSize=e};this.setMeanSpeed=function(e){this.meanSpeed=e};this.setCalory=function(e){this.calory=e};this.setSensibility=function(e){this.sensibility=e};this.createTable=function(e){this.acc_norm=new Array(e);this.stepArr=new Array(e)};this.update=function(){this.acc_norm.shift()};this.computeNorm=function(e,t,n){var r=Math.sqrt(Math.pow(e,2)+Math.pow(t,2)+Math.pow(n,2));var i=this.filtre.onFilteringKalman(r);return i/9.80665};this.varAcc=function(e){var t=0;var n=0;for(var r=0;r<e.length-1;r++){t+=e[r];n+=Math.pow(e[r],2)}this.var_acc=(Math.pow(t,2)-n)/e.length;if(this.var_acc-.5>0){this.var_acc-=.5}if(isNaN(this.var_acc)==0){this.filtre.setRv(this.var_acc);this.setSensibility(2*Math.sqrt(this.var_acc)/Math.pow(9.80665,2))}else{this.setSensibility(1/30)}};this.minAcc=function(e){var t=1/0;for(var n=0;n<e.length-1;n++){if(e[n]<t){t=e[n]}}return t};this.maxAcc=function(e){var t=-1/0;for(var n=0;n<e.length-1;n++){if(e[n]>t){t=e[n]}}return t};this.setThreshold=function(e,t){this.threshold=(e+t)/2};this.onStep=function(e){this.varAcc(e);this.min_acc=this.minAcc(e);this.max_acc=this.maxAcc(e);this.setThreshold(this.min_acc,this.max_acc);var t=this.max_acc-this.min_acc;var n=Math.abs(t)>=this.sensibility;var r=e[e.length-1]>=this.threshold&&e[e.length-2]<this.threshold;var i=this.stepArr[this.stepArr.length-1]==0;if(n&&r&&i){this.countStep++;this.stepArr.push(1);this.stepArr.shift()}else{this.stepArr.push(0);this.stepArr.shift()}this.setDistance()};this.setDistance=function(){this.distance=this.countStep*this.stepSize};this.onSpeed=function(){stepin2s=0;this.speed=0;for(var e=0;e<this.stepArr.length;e++){stepin2s+=this.stepArr[e]}var t=stepin2s*this.stepSize;this.speed=t/100/2;if(this.stepArr[this.stepArr.length-1]!==0&&this.speed!==0&&isNaN(this.speed)==0){if(isNaN(this.meanSpeed)==0){this.meanSpeed=(this.meanSpeed*(this.countStep-1)+this.speed)/this.countStep}else{this.meanSpeed=this.speed}}};this.onCalory=function(){if(isNaN(this.speed)==0&&isNaN(this.calory)==0){this.calory+=this.speed*this.weight/400}};this.onDraw=function(e,t,n){e.clearRect(0,0,t,n);var r=15;var i=n/2*5/6;var s=Math.PI/180*150;e.lineWidth=1;e.save();e.beginPath();e.arc(t/2,n/2,i,Math.PI/180*150,Math.PI/180*30);e.stroke();for(var o=0;o<=r;o++){e.beginPath();s=Math.PI/180*(150+o*240/r);if(o%5==0){e.font="bold 16pt Calibri,Geneva,Arial";e.strokeStyle="rgb(0, 128, 128)";e.fillText(o,t/2+i*1.1*Math.cos(s)-e.measureText(o).width/2,n/2+i*1.1*Math.sin(s))}else{e.strokeStyle="rgb(0, 0, 0)"}e.moveTo(t/2+i/1.05*Math.cos(s),n/2+i/1.05*Math.sin(s));e.lineTo(t/2+i*Math.cos(s),n/2+i*Math.sin(s));e.stroke()}e.font="10pt Calibri,Geneva,Arial";e.strokeStyle="rgb(0, 0, 0)";e.fillText("km/h",t/2-e.measureText("km/h").width/2,n*1/3);e.lineWidth=5;e.save();e.restore();e.beginPath();e.strokeStyle="rgb(0, 0, 0)";if(isNaN(this.speed)==1){s=Math.PI/180*(150+0*240/r)}else if(this.speed/1e3*3600>r){s=Math.PI/180*(150+r*240/r)}else{s=Math.PI/180*(150+Math.round(this.speed/1e3*3600)*240/r)}e.moveTo(t/2,n/2);e.lineTo(t/2+i*.9*Math.cos(s),n/2+i*.9*Math.sin(s));e.stroke();e.beginPath();e.fillStyle="rgb(0, 128, 128)";e.arc(t/2+i*.95*Math.cos(s),n/2+i*.95*Math.sin(s),i*.05,0,2*Math.PI);e.fill();e.font="bold 48pt Calibri,Geneva,Arial";e.strokeStyle="rgb(0, 0, 0)";e.fillText(this.countStep,t/2-e.measureText(this.countStep).width/2,n*5/6);e.restore()}}